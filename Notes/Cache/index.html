<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=description content="Cache Memory Organisation Memory in cache is stored as cache lines. A CPU will try to access cache through a memory address: Instruction cache and Data cache Storing these separately will allow in better parallelism."><title>Cache
</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.brendanang.dev//icon.png><link href=https://www.brendanang.dev/styles.c6adaa3b473914a38283f492dfdbcb76.min.css rel=stylesheet><link href=https://www.brendanang.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.brendanang.dev/js/darkmode.f4d43c22d05773345705b5a308888af6.min.js></script><script src=https://www.brendanang.dev/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script><script src=https://unpkg.com/@floating-ui/core@0.7.3></script><script src=https://unpkg.com/@floating-ui/dom@0.5.4></script><script src=https://www.brendanang.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script><script src=https://www.brendanang.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script><script src=https://www.brendanang.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script><script src=https://www.brendanang.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script><script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://www.brendanang.dev/",fetchData=Promise.all([fetch("https://www.brendanang.dev/indices/linkIndex.3b821336bb0d2a72afc0299da481936f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.brendanang.dev/indices/contentIndex.7651dcea5c2990cf05b7a781aa72d966.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.brendanang.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://www.brendanang.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{"’":"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.brendanang.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script><script defer src=https://www.brendanang.dev/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.brendanang.dev/>Brendan Ang</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg>
</label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Cache</h1><p class=meta>Last updated
Nov 8, 2022
<a href=https://github.com/bbawj/site/Notes/Cache.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#memory-organisation>Memory Organisation</a><ol><li><a href=#instruction-cache-and-data-cache>Instruction cache and Data cache</a></li></ol></li><li><a href=#cache-placement-policiesnotescache20placement20policiesmd><a href=Notes/Cache%20Placement%20Policies.md>Cache Placement Policies</a></a></li><li><a href=#cache-replacement-policiesnotescache20replacement20policiesmd><a href=Notes/Cache%20Replacement%20Policies.md>Cache Replacement Policies</a></a></li><li><a href=#cache-write-policiesnotescache20write20policiesmd><a href=Notes/Cache%20Write%20Policies.md>Cache Write Policies</a></a></li><li><a href=#performance>Performance</a><ol><li><a href=#types-of-misses>Types of Misses</a></li><li><a href=#design-considerations>Design considerations</a></li><li><a href=#measuring-impact-with-cpi>Measuring Impact with CPI</a></li><li><a href=#measuring-impact-with-average-memory-access-time-amat>Measuring Impact with Average Memory Access Time (AMAT)</a></li></ol></li><li><a href=#practice-problems>Practice Problems</a></li></ol></nav></details></aside><a href=#cache><h1 id=cache><span class=hanchor arialabel=Anchor># </span>Cache</h1></a><a href=#memory-organisation><h2 id=memory-organisation><span class=hanchor arialabel=Anchor># </span>Memory Organisation</h2></a><p>Memory in cache is stored as cache lines.
<img src=https://i.imgur.com/NUtGrGp.png width=auto alt>
A CPU will try to access cache through a memory address:
<img src=https://i.imgur.com/6Otcpnl.png width=auto alt></p><a href=#instruction-cache-and-data-cache><h3 id=instruction-cache-and-data-cache><span class=hanchor arialabel=Anchor># </span>Instruction cache and Data cache</h3></a><p>Storing these separately will allow in better parallelism. CPU is able to fetch instructions from instruction cache while writing to data cache for STUR instructions.
<img src=https://i.imgur.com/tA6cvb2.png width=auto alt></p><h2 id=cache-placement-policiesnotescache20placement20policiesmd><a href=/Notes/Cache-Placement-Policies/ rel=noopener class=internal-link data-src=/Notes/Cache-Placement-Policies/>Cache Placement Policies</a></h2><h2 id=cache-replacement-policiesnotescache20replacement20policiesmd><a href=/Notes/Cache-Replacement-Policies/ rel=noopener class=internal-link data-src=/Notes/Cache-Replacement-Policies/>Cache Replacement Policies</a></h2><h2 id=cache-write-policiesnotescache20write20policiesmd><a href=/Notes/Cache-Write-Policies/ rel=noopener class=internal-link data-src=/Notes/Cache-Write-Policies/>Cache Write Policies</a></h2><a href=#performance><h2 id=performance><span class=hanchor arialabel=Anchor># </span>Performance</h2></a><p>The key factor affecting cache performance is the effects of cache misses. When a cache miss occurs, compute cycles are needed to find a victim, request the appropriate data from memory, fill the cache line with this new block and resume execution.</p><a href=#types-of-misses><h3 id=types-of-misses><span class=hanchor arialabel=Anchor># </span>Types of Misses</h3></a><a href=#compulsory-miss><h4 id=compulsory-miss><span class=hanchor arialabel=Anchor># </span>Compulsory miss</h4></a><p>First reference to a given block of memory. This is an inevitable miss as data has not been accessed before.</p><a href=#capacity-miss><h4 id=capacity-miss><span class=hanchor arialabel=Anchor># </span>Capacity miss</h4></a><p>This occurs when the current working set exceeds the cache capacity. Current useful blocks have to be replaced.</p><a href=#conflict-miss><h4 id=conflict-miss><span class=hanchor arialabel=Anchor># </span>Conflict miss</h4></a><p>When useful blocks are displaced due to placement policies. E.g. fully associative cache mapping</p><a href=#design-considerations><h3 id=design-considerations><span class=hanchor arialabel=Anchor># </span>Design considerations</h3></a><ul><li>Number of blocks<ul><li>More blocks means that we will have larger capacity and result in lesser capacity misses</li></ul></li><li>Associativity<ul><li>Reduce conflict misses</li><li>Increases access time</li></ul></li><li>Block size<ul><li>Larger blocks exploit spatial locality. More data in the same area is loaded together when requested.</li><li>Reduces compulsory misses since more data is loaded at once.</li><li>Reduces number of cache blocks for a fixed block size. This leads to increase in conflict miss as higher chance for different data map to the same blocks.</li><li>Increases miss penalty as more data needs to be replaced on a miss.</li></ul></li><li>Levels of cache<ul><li>Using multi-level cache will reduce the miss penalty
<img src=https://i.imgur.com/PKhDsDq.png width=auto alt></li></ul></li></ul><a href=#false-sharing><h4 id=false-sharing><span class=hanchor arialabel=Anchor># </span>False sharing</h4></a><p>An issue arises when different cores have cached values which share the same cache line. The picture below depicts how 2 cores try to access different independent values (X and Y) that resides on the same cache line in L3 cache.
<img src=https://i.imgur.com/5r29qAP.png width=auto alt>
If X and Y are highly used variables</p><ul><li>Writing to X invalidates the cache line in Core 2</li><li>Writing to Y invalidates the cache line in Core 1</li></ul><a href=#measuring-impact-with-cpi><h3 id=measuring-impact-with-cpi><span class=hanchor arialabel=Anchor># </span>Measuring Impact with CPI</h3></a><p>$$
\begin{align}
&amp;CPU_{time}=(CPU_{\text{execution cycles}}+\text{Memory stall cycles})\times\text{Cycle Time}\\ &amp;CPU_{time}=((IC\times CPI)+(IC\times%\text{Memory Access}\times\text{Miss Rate}\times\text{Miss Penalty}))\times \text{Cycle Time}
\end{align}
$$
<img src=https://i.imgur.com/38DnZ86.png width=auto alt>
L1 cache hit can be considered to be part of CPI ideal as it is often possible to complete the data access within the ideal clock cycles.</p><a href=#example><h4 id=example><span class=hanchor arialabel=Anchor># </span>Example</h4></a><p><img src=https://i.imgur.com/pcXWyud.png width=auto alt></p><a href=#multi-level-cache-example><h4 id=multi-level-cache-example><span class=hanchor arialabel=Anchor># </span>Multi-level cache example</h4></a><p><img src=https://i.imgur.com/pN98QXK.png width=auto alt></p><a href=#measuring-impact-with-average-memory-access-time-amat><h3 id=measuring-impact-with-average-memory-access-time-amat><span class=hanchor arialabel=Anchor># </span>Measuring Impact with Average Memory Access Time (AMAT)</h3></a><p>We need a way to measure the performance of cache, standalone from the performance of the CPU.
AMAT is the average time to access memory considering both hits and misses
$$
\begin{aligned}
AMAT&=\text{Hit Time}\times(1-\text{Miss Rate})+\text{Miss Rate}\times(\text{Hit Time}+\text{Miss Penalty})\\ &=\text{Time for hit}+\text{Miss Rate}\times\text{Miss Penalty}\\ \end{aligned}
$$
Note here that <em>Miss Penalty</em> is the loss in cycles for a miss, and not just the cost of main memory access. e.g If time to hit cache = 1, time to hit main memory = 100, miss penalty is $100-1=99$.
<img src=https://i.imgur.com/4RDpPr0.png width=auto alt>
One example to show that AMAT is superior would be to consider two different caches with similar miss rates, but drastically different hit times. Using the miss rate metric, we would rate both caches the same. Using the AMAT metric, a cache with a lower hit time or lower miss penalty will outperform a cache with a higher respective time, assuming all other variables are the same.</p><a href=#practice-problems><h2 id=practice-problems><span class=hanchor arialabel=Anchor># </span>Practice Problems</h2></a><p><img src=https://i.imgur.com/bo5A0np.png width=auto alt>
3 bit index, 2bit tag with 0 bit offset.</p><table><thead><tr><th>Addr</th><th>Index</th><th>Tag</th><th>H/M</th><th>State</th></tr></thead><tbody><tr><td>10011</td><td>011</td><td>10</td><td>M</td><td>001,10</td></tr><tr><td>00001</td><td>001</td><td>00</td><td>H</td><td></td></tr><tr><td>00110</td><td>110</td><td>00</td><td>H</td><td></td></tr><tr><td>01010</td><td>010</td><td>01</td><td>M</td><td>010,01</td></tr><tr><td>01110</td><td>110</td><td>01</td><td>M</td><td>110,01</td></tr><tr><td>11001</td><td>001</td><td>11</td><td>M</td><td>001,11</td></tr><tr><td>00001</td><td>001</td><td>00</td><td>M</td><td>001,00</td></tr><tr><td>11100</td><td>100</td><td>11</td><td>M</td><td>100,11</td></tr><tr><td>10100</td><td>100</td><td>10</td><td>M</td><td>100,10</td></tr><tr><td><img src=https://i.imgur.com/8uzwhdW.png width=auto alt></td><td></td><td></td><td></td><td></td></tr><tr><td>Bits for offset = $log_24=2$</td><td></td><td></td><td></td><td></td></tr><tr><td>2 way set associative cache: Each set contains 2 cache lines -> 2 blocks per set -> 8 bytes per set -> 2 sets</td><td></td><td></td><td></td><td></td></tr><tr><td>Bits for index -> 1</td><td></td><td></td><td></td><td></td></tr><tr><td>Access</td><td>10001101</td><td>10110010</td><td>10111111</td><td>100001100</td></tr><tr><td>&mdash;&mdash;</td><td>&mdash;&mdash;&ndash;</td><td>&mdash;&mdash;&ndash;</td><td>&mdash;&mdash;&ndash;</td><td>&mdash;&mdash;&mdash;</td></tr><tr><td>Tag</td><td>10001</td><td>10110</td><td>10111</td><td>10001</td></tr><tr><td>Offset</td><td>01</td><td>10</td><td>11</td><td>00</td></tr><tr><td>Index</td><td>1</td><td>0</td><td>1</td><td>1</td></tr><tr><td>H/M</td><td>M</td><td>M</td><td>M</td><td>H</td></tr><tr><td>LRU1</td><td>10001</td><td>10110</td><td>10111</td><td>10001</td></tr><tr><td>LRU2</td><td>NA</td><td>NA</td><td>10001</td><td>10111</td></tr></tbody></table><p>Hit rate: 2/8 = 25%
<img src=https://i.imgur.com/ZUWtOC2.png width=auto alt>
a.
$$
\begin{align}
&amp;T=IC\times CPI\times Period\\ &amp;CPI_{ideal}=1.25\\ &\text{L1 stall cycles}=0.2\times0.2\times8=0.32\\ &\text{L2 stall cycles}=0.2\times0.2\times0.1\times30=0.12\\ &\text{CPI stall}=1.25+0.32+0.12=1.69\\ \end{align}
$$
b.
$$
\begin{align}
&\text{L1 stall cycles}=0.2\times0.2\times30=1.2\\ &\text{CPI stall}=1.25+1.2=2.45
\end{align}
$$</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/3001-Advanced-Computer-Architecture/ data-ctx=Cache data-src=/3001-Advanced-Computer-Architecture class=internal-link>3001 Advanced Computer Architecture</a></li><li><a href=/Notes/Storage/ data-ctx=Cache data-src=/Notes/Storage class=internal-link>Storage</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.brendanang.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2024</p><ul><li><a href=https://www.brendanang.dev/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>