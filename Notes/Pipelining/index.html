<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Pipelining  Datapath Pipelining makes use of extra registers between each pipeline in order to store the necessary data and control signals needed by the current instruction for the next stage."><title>Pipelining</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.brendanang.dev//icon.png><link href=https://www.brendanang.dev/styles.c6adaa3b473914a38283f492dfdbcb76.min.css rel=stylesheet><link href=https://www.brendanang.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.brendanang.dev/js/darkmode.f4d43c22d05773345705b5a308888af6.min.js></script>
<script src=https://www.brendanang.dev/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.brendanang.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://www.brendanang.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.brendanang.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.brendanang.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://www.brendanang.dev/",fetchData=Promise.all([fetch("https://www.brendanang.dev/indices/linkIndex.98e750b01af4595d294e9c1de7529692.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.brendanang.dev/indices/contentIndex.90c1975bd3e52dc2ff8254086c2ab0f5.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.brendanang.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://www.brendanang.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.brendanang.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.brendanang.dev/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.brendanang.dev/>Brendan Ang</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Pipelining</h1><p class=meta>Last updated
Nov 8, 2022
<a href=https://github.com/bbawj/site/Notes/Pipelining.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#datapath>Datapath</a><ol><li><a href=#clock-period>Clock Period</a></li><li><a href=#limitation>Limitation</a></li></ol></li><li><a href=#hazards>Hazards</a><ol><li><a href=#data-hazard>Data hazard</a></li><li><a href=#control-hazard>Control hazard</a></li><li><a href=#structural-hazard>Structural hazard</a></li></ol></li><li><a href=#practice-problems>Practice Problems</a></li></ol></nav></details></aside><a href=#pipelining><h1 id=pipelining><span class=hanchor arialabel=Anchor># </span>Pipelining</h1></a><p><img src=https://i.imgur.com/q5XIG5f.png width=auto alt></p><a href=#datapath><h2 id=datapath><span class=hanchor arialabel=Anchor># </span>Datapath</h2></a><p>Pipelining makes use of extra registers between each pipeline in order to store the necessary data and control signals needed by the current instruction for the next stage. Without it, the next instruction will override the information.
<img src=https://i.imgur.com/fAFW3V8.png width=auto alt></p><a href=#clock-period><h3 id=clock-period><span class=hanchor arialabel=Anchor># </span>Clock Period</h3></a><p>Pipelining allows us to achieve smaller clock period (and hence higher frequencies) by reducing the time required for a single stage to complete.
<img src=https://i.imgur.com/U02KVRZ.png width=auto alt></p><a href=#limitation><h3 id=limitation><span class=hanchor arialabel=Anchor># </span>Limitation</h3></a><p><img src=https://i.imgur.com/HZTDkkx.png width=auto alt></p><ul><li>Single cycle: $1.2+0.8+0.7+1.3=4ns$</li><li>Pipelined: $1.3+0.3=1.6ns$ (register delay needs to be taken into account)
<img src=https://i.imgur.com/AzTIQBp.png width=auto alt>
Clock period of a single stage = $4/1000 = 0.004ns$
Maximum delay = $0.004+0.3=0.304ns$
Speedup = $4/0.304=13$
<em>A 1000x increase in pipeline registers only results in a 13x increase in speedup!</em></li></ul><a href=#hazards><h2 id=hazards><span class=hanchor arialabel=Anchor># </span>Hazards</h2></a><p>A hazard is a drop in efficiency in the pipeline due to stalling.
We can measure the effect of stalls using steady state CPI
$$\text{Steady State CPI} = (No.Instructions+No.Stalls)/No.Instructions$$</p><a href=#data-hazard><h3 id=data-hazard><span class=hanchor arialabel=Anchor># </span>Data hazard</h3></a><p>When either the source or destination register of an instruction is not available at the time expected in the pipeline.
<img src=https://i.imgur.com/PadZEnm.png width=auto alt>
RAW dependencies are difficult to handle and results in stalling for a pipeline architecture.</p><a href=#detect-and-wait><h4 id=detect-and-wait><span class=hanchor arialabel=Anchor># </span>Detect and Wait</h4></a><p>Wait until the required value is available in the register file by stalling (hardware) or inserting NOPs (software)
<img src=https://i.imgur.com/A7fwKHg.png width=auto alt></p><a href=#data-forwarding><h4 id=data-forwarding><span class=hanchor arialabel=Anchor># </span>Data Forwarding</h4></a><p><strong>Data forwarding via register</strong>: We can write and read from register in the same clock cycle. This means that WRITE-BACK and DECODE stage can happen at the same time
<img src=https://i.imgur.com/GtevmBH.png width=auto alt></p><blockquote class=note-callout><p>Forwarding via register is easy to implement. Even when we say there is no forwarding, forwarding via register is considered to still be in place</p></blockquote><p>For other stages, we can only forward from the <em>previous</em> clock cycle:
<img src=https://i.imgur.com/OIFnJei.png width=auto alt>
Notes</p><ul><li>SUB needs X1 value latest during the execute stage</li><li>AND can obtain X1 latest through register forwarding</li></ul><a href=#dynamic-scheduling><h4 id=dynamic-scheduling><span class=hanchor arialabel=Anchor># </span>Dynamic Scheduling</h4></a><p>Out-of-order execution and completion:
<img src=https://i.imgur.com/Uxcv79x.png width=auto alt>
Reordering introduces the possibility of WAR and WAW hazards which were not possible in an in-order execution pipeline. These can be solved via <strong>register renaming</strong>:
<img src=https://i.imgur.com/E8tAmwX.png width=auto alt></p><a href=#loop-unrolling><h4 id=loop-unrolling><span class=hanchor arialabel=Anchor># </span>Loop Unrolling</h4></a><p>Further optimizations can be made for looping code. Loop segments contain a high level of overhead <em>(lines that work on the loop variable and branch commands)</em>, which are not directly contributing to the work of the loop body.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>for (i=999; i&gt;=0; i=i–1) 
</span></span><span class=line><span class=cl>	x[i] = x[i] + s;
</span></span><span class=line><span class=cl>&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span><span class=line><span class=cl>L.D F0,0(R1) 
</span></span><span class=line><span class=cl>DADDUI R1,R1,#-8 //overhead
</span></span><span class=line><span class=cl>ADD.D F4,F0,F2  
</span></span><span class=line><span class=cl>stall //overhead
</span></span><span class=line><span class=cl>stall //overhead
</span></span><span class=line><span class=cl>S.D F4,8(R1) 
</span></span><span class=line><span class=cl>BNE R1,R2,Loop //overhead
</span></span></code></pre></td></tr></table></div></div><p><img src=https://i.imgur.com/fncX13C.png width=auto alt>
Combine unrolling with dynamic scheduling:
<img src=https://i.imgur.com/OaYIm4y.png width=auto alt>
Example of 4 factor unrolling:
<img src=https://i.imgur.com/jlNkMYu.png width=auto alt></p><a href=#control-hazard><h3 id=control-hazard><span class=hanchor arialabel=Anchor># </span>Control hazard</h3></a><p>Conditional and unconditional jumps, subroutine calls, and other program control instructions can stall a pipeline because of a delay in the availability of an instruction.</p><p>A naive (conservative) way would be to stall the pipeline whenever we encounter a branch instruction. Depending on hardware, this results in number of stalls (<em>branch penalty</em>) based on which stage of the pipeline the branch address is determined.
<img src=https://i.imgur.com/QY93XPM.png width=auto alt>
Worst case: One clock cycle stall or flush of one instruction after each branch.
$\text{Pipeline Stall Cycles per Instruction due to Branches} = \text{Branch frequency} \times \text{Branch Penalty}$</p><a href=#static-branch-prediction><h4 id=static-branch-prediction><span class=hanchor arialabel=Anchor># </span>Static Branch Prediction</h4></a><p><img src=https://i.imgur.com/nWF7PMD.png width=auto alt></p><p><img src=https://i.imgur.com/TCYnvwC.png width=auto alt>
Delayed Branching: schedule an independent instruction in the branch delay slot. If branch penalty is 1, we will have 1 branch delay slot.
<img src=https://i.imgur.com/uCzBjHJ.png width=auto alt></p><a href=#dynamic-prediction><h4 id=dynamic-prediction><span class=hanchor arialabel=Anchor># </span>Dynamic Prediction</h4></a><p>Rely on some measure of past behaviour to predict the future
<img src=https://i.imgur.com/sYQCIaK.png width=auto alt>
<img src=https://i.imgur.com/Y7NNWYA.png width=auto alt>
<img src=https://i.imgur.com/k13iMgt.png width=auto alt></p><a href=#structural-hazard><h3 id=structural-hazard><span class=hanchor arialabel=Anchor># </span>Structural hazard</h3></a><p>When two instructions require the use of a given hardware resource at the same time that will lead to a stall in the pipeline (one instruction has to wait at least for a clock cycle).</p><p>Consider we have only one memory. For a case when write stage access the memory for writing the result and the instruction fetch stage tries to fetch the instruction from the memory at the same time.</p><a href=#practice-problems><h2 id=practice-problems><span class=hanchor arialabel=Anchor># </span>Practice Problems</h2></a><p><img src=https://i.imgur.com/dyOmM4b.png width=auto alt>
a. Pipelined minimum is the max of all the stages: 500ps
Non-pipelined min is the sum of all stages: 1650ps
b. LDUR: IF -> ID -> EX -> MEM -> WB
Non-pipelined sum all stages: 1650ps
Pipelined: Each stage must take 500ps leading to 2500ps
c. MEM stage. Clock period: 400ps
d.</p><ol><li>Used in LDUR and STUR 25%</li><li>Used in ALU and LDUR 65%
<img src=https://i.imgur.com/pPz8itY.png width=auto alt>
a. 2 stall cycles per hazard = 6 total
<img src=https://www.brendanang.dev//Excalidraw/Drawing%202022-09-03%2000.35.07.excalidraw.md width=auto alt=800>
b.</li><li>LDUR instruction requires X0 latest at the execute stage, where the ALU calculates the memory address value. X0 is known at the E stage of ADDI: 0 stalls required</li><li>ADD instruction requires X2 latest at the E stage. X2 is known at the MEM stage of LDUR when it is loaded from data memory. Forward from M -> E: **1 stall</li><li>STUR instruction requires X3 latest at the Mem stage where it is put into data memory. X3 is updated at the E stage of ADD: 0 stalls required
c.
No Forwarding CPI: $(6+6)/6 =2$
Forwarding CPI: $(6+1)/6 =1.17$
<img src=https://i.imgur.com/t8JyCXO.png width=auto alt>
a.
Always taken: 75%, 60%
Always not taken: 25%, 40%
b.</li><li>0%</li><li>20%
c.</li><li>Only 1 not taken states, resulting in predictor staying in the 11 and 10 states. 75%</li><li>40%. Cycle from 11->10->01
<img src=https://i.imgur.com/aF3LbdX.png width=auto alt>
a. How to do this one?
<img src=https://www.brendanang.dev//Pics/Pipelining%202022-09-12%2010.49.44.excalidraw.md width=auto alt="Pipelining 2022-09-12 10.49.44.excalidraw">
Number of stalls per loop = 2 + 2 + 1 = 5
Total useful instructions: $1+6\times x= 1+6x$
Total instructions: $1+(6+5)\times x=1+11x$
x = 5: $\frac{31}{56}=0.55$
x = 100: $\frac{601}{1101}=
b.
<img src=https://www.brendanang.dev//Pics/Pipelining%202022-09-12%2011.33.33.excalidraw.md width=auto alt="Pipelining 2022-09-12 11.33.33.excalidraw"></li></ol><p><img src=https://i.imgur.com/fbYe55h.png width=auto alt>
$$
\begin{align}
&\text{Branch Penalty Unconditional}=1
&\text{Branch Penalty Conditional}=2\\ &\text{Stall cycles Unconditional}=0.01\times1=0.01\\ &\text{Stall cycles Conditional}=0.15\times0.6\times2=0.18\\ &CPI = 1+0.18+0.1=1.19
\end{align}
$$</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/3001-Advanced-Computer-Architecture/ data-ctx=Pipelining data-src=/3001-Advanced-Computer-Architecture class=internal-link>3001 Advanced Computer Architecture</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.brendanang.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.brendanang.dev/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>