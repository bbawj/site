<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Allocators A kernel often also requires support for heap allocation. With the support of Paging, we can define a virtual memory range and map it to physical frames."><title>Allocators</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.brendanang.dev//icon.png><link href=https://www.brendanang.dev/styles.c6adaa3b473914a38283f492dfdbcb76.min.css rel=stylesheet><link href=https://www.brendanang.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.brendanang.dev/js/darkmode.f4d43c22d05773345705b5a308888af6.min.js></script>
<script src=https://www.brendanang.dev/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.brendanang.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://www.brendanang.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.brendanang.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.brendanang.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://www.brendanang.dev/",fetchData=Promise.all([fetch("https://www.brendanang.dev/indices/linkIndex.766f6378416d06929f0850ebe8548419.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.brendanang.dev/indices/contentIndex.2ef04b81ecf316e06ecb73f191794004.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.brendanang.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://www.brendanang.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.brendanang.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.brendanang.dev/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.brendanang.dev/>Brendan Ang</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Allocators</h1><p class=meta>Last updated
Jul 15, 2023
<a href=https://github.com/bbawj/site/Notes/Allocators.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#bump-allocator>Bump Allocator</a><ol><li><a href=#pros-and-cons>Pros and Cons</a></li></ol></li></ol></nav></details></aside><a href=#allocators><h1 id=allocators><span class=hanchor arialabel=Anchor># </span>Allocators</h1></a><p>A kernel often also requires support for heap allocation. With the support of
<a href=/Notes/Memory-Organisation/ rel=noopener class=internal-link data-src=/Notes/Memory-Organisation/>Paging</a>, we can define a virtual memory range and map it to physical frames. Now, all we need is an allocator.</p><p>The job of an allocator is to manage the available heap memory. It needs to return unused memory on <code>alloc</code> calls and keep track of memory freed by <code>dealloc</code> so that it can be reused again. Most importantly, it must never hand out memory that is already in use somewhere else because this would cause undefined behavior.</p><a href=#bump-allocator><h2 id=bump-allocator><span class=hanchor arialabel=Anchor># </span>Bump Allocator</h2></a><p>The idea behind a bump allocator is to linearly allocate memory by increasing (<em>“bumping”</em>) a <code>next</code> variable, which points to the start of the unused memory. At the beginning, <code>next</code> is equal to the start address of the heap. On each allocation, <code>next</code> is increased by the allocation size so that it always points to the boundary between used and unused memory:
<img src=https://www.brendanang.dev//Pics/Pasted%20image%2020230715101712.png width=auto alt></p><a href=#pros-and-cons><h3 id=pros-and-cons><span class=hanchor arialabel=Anchor># </span>Pros and Cons</h3></a><ul><li>The big advantage of bump allocation is that it’s very fast. Compared to other allocator designs that need to actively look for a fitting memory block and perform various bookkeeping tasks on <code>alloc</code> and <code>dealloc</code>, a bump allocator
<a href=https://fitzgeraldnick.com/2019/11/01/always-bump-downwards.html rel=noopener>can be optimized</a> to just a few assembly instructions. This makes bump allocators useful for optimizing the allocation performance, for example when creating a
<a href=https://hacks.mozilla.org/2019/03/fast-bump-allocated-virtual-doms-with-rust-and-wasm/ rel=noopener>virtual DOM library</a>.</li><li>The main limitation of a bump allocator is that it can only reuse deallocated memory after all allocations have been freed. This means that a single long-lived allocation suffices to prevent memory reuse.<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust></code></pre></td></tr></table></div></div></li></ul><p>fn many_boxes_long_lived() {
let long_lived = Box::new(1); // new
for i in 0..HEAP_SIZE {
let x = Box::new(i);
assert_eq!(*x, i);
}
assert_eq!(*long_lived, 1); // new
}</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>### Tricks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>-</span><span class=w> </span><span class=n>We</span><span class=w> </span><span class=n>could</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=o>`</span><span class=n>dealloc</span><span class=o>`</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=n>whether</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>freed</span><span class=w> </span><span class=n>allocation</span><span class=w> </span><span class=n>was</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=n>allocation</span><span class=w> </span><span class=n>returned</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=n>alloc</span><span class=o>`</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>comparing</span><span class=w> </span><span class=n>its</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>next</span><span class=o>`</span><span class=w> </span><span class=n>pointer</span><span class=p>.</span><span class=w> </span><span class=k>In</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=n>they</span><span class=err>’</span><span class=n>re</span><span class=w> </span><span class=n>equal</span><span class=p>,</span><span class=w> </span><span class=n>we</span><span class=w> </span><span class=n>can</span><span class=w> </span><span class=n>safely</span><span class=w> </span><span class=n>reset</span><span class=w> </span><span class=o>`</span><span class=n>next</span><span class=o>`</span><span class=w> </span><span class=n>back</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>freed</span><span class=w> </span><span class=n>allocation</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>way</span><span class=p>,</span><span class=w> </span><span class=k>each</span><span class=w> </span><span class=k>loop</span><span class=w> </span><span class=n>iteration</span><span class=w> </span><span class=n>reuses</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>same</span><span class=w> </span><span class=n>memory</span><span class=w> </span><span class=n>block</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=w> </span><span class=n>We</span><span class=w> </span><span class=n>could</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=o>`</span><span class=n>alloc_back</span><span class=o>`</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>allocates</span><span class=w> </span><span class=n>memory</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>_end_</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>heap</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>additional</span><span class=w> </span><span class=o>`</span><span class=n>next_back</span><span class=o>`</span><span class=w> </span><span class=n>field</span><span class=p>.</span><span class=w> </span><span class=k>Then</span><span class=w> </span><span class=n>we</span><span class=w> </span><span class=n>could</span><span class=w> </span><span class=n>manually</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>allocation</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=k>long</span><span class=o>-</span><span class=n>lived</span><span class=w> </span><span class=n>allocations</span><span class=p>,</span><span class=w> </span><span class=n>thereby</span><span class=w> </span><span class=n>separating</span><span class=w> </span><span class=n>short</span><span class=o>-</span><span class=n>lived</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>long</span><span class=o>-</span><span class=n>lived</span><span class=w> </span><span class=n>allocations</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>heap</span><span class=p>.</span><span class=w> </span><span class=n>Note</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>separation</span><span class=w> </span><span class=n>only</span><span class=w> </span><span class=n>works</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>it</span><span class=err>’</span><span class=n>s</span><span class=w> </span><span class=n>clear</span><span class=w> </span><span class=n>beforehand</span><span class=w> </span><span class=n>how</span><span class=w> </span><span class=k>long</span><span class=w> </span><span class=k>each</span><span class=w> </span><span class=n>allocation</span><span class=w> </span><span class=n>will</span><span class=w> </span><span class=n>live</span><span class=p>.</span><span class=w> </span><span class=n>Another</span><span class=w> </span><span class=n>drawback</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>approach</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>manually</span><span class=w> </span><span class=n>performing</span><span class=w> </span><span class=n>allocations</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>cumbersome</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>potentially</span><span class=w> </span><span class=n>unsafe</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>### The fundamental issue
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>A</span><span class=w> </span><span class=n>bump</span><span class=w> </span><span class=n>allocator</span><span class=w> </span><span class=n>cant</span><span class=w> </span><span class=n>effectively</span><span class=w> </span><span class=n>reuse</span><span class=w> </span><span class=n>freed</span><span class=w> </span><span class=n>memory</span><span class=w> </span><span class=n>regions</span><span class=p>.</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>!</span><span class=p>[</span><span class=n>png</span><span class=p>](</span><span class=n>Pics</span><span class=o>/</span><span class=n>Pasted</span><span class=o>%</span><span class=mi>20</span><span class=n>image</span><span class=o>%</span><span class=mi>2020230715102700</span><span class=p>.</span><span class=n>png</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>There</span><span class=w> </span><span class=n>are</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>total</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>unused</span><span class=w> </span><span class=n>memory</span><span class=w> </span><span class=n>regions</span><span class=p>,</span><span class=w> </span><span class=n>but</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=n>pointer</span><span class=w> </span><span class=n>only</span><span class=w> </span><span class=n>gives</span><span class=w> </span><span class=n>us</span><span class=w> </span><span class=n>access</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>last</span><span class=w> </span><span class=n>one</span><span class=p>.</span><span class=w> </span><span class=n>We</span><span class=w> </span><span class=n>could</span><span class=w> </span><span class=n>store</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>unused</span><span class=w> </span><span class=n>regions</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>constant</span><span class=w> </span><span class=n>sized</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=n>but</span><span class=w> </span><span class=n>we</span><span class=w> </span><span class=n>would</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>able</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>know</span><span class=w> </span><span class=n>what</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>how</span><span class=w> </span><span class=n>large</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=n>could</span><span class=w> </span><span class=n>get</span><span class=p>.</span><span class=w> </span><span class=n>We</span><span class=w> </span><span class=n>can</span><span class=s1>&#39;t use dynamic data structures, because then our heap allocator would depend on itself.
</span></span></span><span class=line><span class=cl><span class=s1>## Linked List Allocator
</span></span></span><span class=line><span class=cl><span class=s1>A linked list can be used to keep track of the freed areas of memory, hence the name, *free list*.
</span></span></span><span class=line><span class=cl><span class=s1>![png](Pics/Pasted%20image%2020230715110728.png)
</span></span></span><span class=line><span class=cl><span class=s1>Freed blocks should be merged together, else it will result in increasing and increasing fragmentation:
</span></span></span><span class=line><span class=cl><span class=s1>![](Pics/Pasted%20image%2020230716171506.png)
</span></span></span><span class=line><span class=cl><span class=s1>### Pros and Cons
</span></span></span><span class=line><span class=cl><span class=s1>- Able to reuse freed memory
</span></span></span><span class=line><span class=cl><span class=s1>- Poorer performance: list length depends on the number of unused memory blocks, the performance can vary extremely for different programs. A program that only creates a couple of allocations will experience relatively fast allocation performance. For a program that fragments the heap with many allocations, however, the allocation performance will be very bad because the linked list will be very long and mostly contain very small blocks.
</span></span></span><span class=line><span class=cl><span class=s1>## Fixed Size Block Allocator
</span></span></span><span class=line><span class=cl><span class=s1>Instead of allocating exactly as much memory as requested, we define a small number of block sizes and round up each allocation to the next block size. For example, with block sizes of 16, 64, and 512 bytes, an allocation of 4 bytes would return a 16-byte block, an allocation of 48 bytes a 64-byte block.
</span></span></span><span class=line><span class=cl><span class=s1>![](Pics/Pasted%20image%2020230716224307.png)
</span></span></span><span class=line><span class=cl><span class=s1>Like the linked list allocator, we keep track of the unused memory by creating a linked list in the unused memory. However, instead of using a single list with different block sizes, we create a separate list for each size class.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>The property that each region in the list is the same size makes for some efficient allocations:
</span></span></span><span class=line><span class=cl><span class=s1>1. Round up the requested allocation size to the next block size. For example, when an allocation of 12 bytes is requested, we would choose the block size of 16 in the above example.
</span></span></span><span class=line><span class=cl><span class=s1>2. Retrieve the head pointer for the list, e.g., for block size 16, we need to use `head_16`.
</span></span></span><span class=line><span class=cl><span class=s1>3. Remove the first block from the list and return it.
</span></span></span><span class=line><span class=cl><span class=s1>Most notably, we can always return the first element of the list and no longer need to traverse the full list. Thus, allocations are much faster than with the linked list allocator. Deallocations also work the same way, by rounding up the freed size and adding the region to the head of the list, we avoid traversing the entire list.
</span></span></span><span class=line><span class=cl><span class=s1>### Fallback Allocator
</span></span></span><span class=line><span class=cl><span class=s1>A fallback allocator like a linked list allocator for allocation sizes which are rare, can reduce memory waste. Since only very few allocations of that size are expected, the linked list would stay small and the (de)allocations would still be reasonably fast.
</span></span></span><span class=line><span class=cl><span class=s1>## Variations
</span></span></span><span class=line><span class=cl><span class=s1>### Slab allocator
</span></span></span><span class=line><span class=cl><span class=s1>Use block sizes that directly correspond to selected types in the kernel. This way, allocations of those types fit a block size exactly and no memory is wasted. Sometimes, it might be even possible to preinitialize type instances in unused blocks to further improve performance.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Slab allocation is often combined with other allocators. For example, it can be used together with a fixed-size block allocator to further split an allocated block in order to reduce memory waste. It is also often used to implement an [object pool pattern](https://en.wikipedia.org/wiki/Object_pool_pattern) on top of a single large allocation.
</span></span></span><span class=line><span class=cl><span class=s1>### Buddy allocator
</span></span></span><span class=line><span class=cl><span class=s1>Instead of using a linked list to manage freed blocks, the [buddy allocator](https://en.wikipedia.org/wiki/Buddy_memory_allocation) design uses a [binary tree](https://en.wikipedia.org/wiki/Binary_tree) data structure together with power-of-2 block sizes. When a new block of a certain size is required, it splits a larger sized block into two halves, thereby creating two child nodes in the tree. Whenever a block is freed again, its neighbor block in the tree is analyzed. If the neighbor is also free, the two blocks are joined back together to form a block of twice the size.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>The advantage of this merge process is that [external fragmentation](https://en.wikipedia.org/wiki/Fragmentation_(computing)#External_fragmentation) is reduced so that small freed blocks can be reused for a large allocation. It also does not use a fallback allocator, so the performance is more predictable. The biggest drawback is that only power-of-2 block sizes are possible, which might result in a large amount of wasted memory due to [internal fragmentation](https://en.wikipedia.org/wiki/Fragmentation_(computing)#Internal_fragmentation). For this reason, buddy allocators are often combined with a slab allocator to further split an allocated block into multiple smaller blocks.
</span></span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.brendanang.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.brendanang.dev/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>