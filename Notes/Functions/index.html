<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Functions The name of the function being called isn’t actually part of the call syntax. The thing being called, the callee, can be any expression that evaluates to a function."><title>Functions</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.brendanang.dev//icon.png><link href=https://www.brendanang.dev/styles.c6adaa3b473914a38283f492dfdbcb76.min.css rel=stylesheet><link href=https://www.brendanang.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.brendanang.dev/js/darkmode.f4d43c22d05773345705b5a308888af6.min.js></script>
<script src=https://www.brendanang.dev/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.brendanang.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://www.brendanang.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.brendanang.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.brendanang.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://www.brendanang.dev/",fetchData=Promise.all([fetch("https://www.brendanang.dev/indices/linkIndex.f42c7fcb66d9399c0737437c54fd65de.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.brendanang.dev/indices/contentIndex.291bac1df7c56517fe90704c41ede862.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.brendanang.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://www.brendanang.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.brendanang.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.brendanang.dev/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.brendanang.dev/>Brendan Ang</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Functions</h1><p class=meta>Last updated
May 23, 2023
<a href=https://github.com/bbawj/site/Notes/Functions.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#currying>Currying</a></li><li><a href=#arity>Arity</a></li><li><a href=#native-functions>Native Functions</a></li><li><a href=#function-declaration>Function declaration</a></li><li><a href=#function-objects>Function Objects</a><ol><li><a href=#call-frames>Call frames</a></li></ol></li><li><a href=#return-statements>Return Statements</a></li><li><a href=#closures>Closures</a><ol><li><a href=#static-scoping>Static Scoping</a></li><li><a href=#semantic-analysis-for-variable-bindings>Semantic Analysis for variable bindings</a></li></ol></li></ol></nav></details></aside><a href=#functions><h1 id=functions><span class=hanchor arialabel=Anchor># </span>Functions</h1></a><p>The name of the function being called isn’t actually part of the call syntax. The thing being called, <em>the callee</em>, can be any expression that evaluates to a function.
<code>getCallback()();</code>
The first pair of parentheses has <code>getCallback</code> as its callee. But the second call has the entire <code>getCallback()</code> expression as its callee. It is the parentheses following an expression that indicate a function call. You can think of a call as sort of like a postfix operator that starts with <code>(</code>.</p><p>Updating our grammar:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>unary          → ( &#34;!&#34; | &#34;-&#34; ) unary | call ;
</span></span><span class=line><span class=cl>call           → primary ( &#34;(&#34; arguments? &#34;)&#34; )* ;
</span></span><span class=line><span class=cl>arguments      → expression ( &#34;,&#34; expression )* ;
</span></span></code></pre></td></tr></table></div></div><p>We can say that a function is one that implements an interface:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>LoxCallable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>arity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Object</span> <span class=nf>call</span><span class=o>(</span><span class=n>Interpreter</span> <span class=n>interpreter</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>arguments</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Interpreting function calls:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Object</span> <span class=nf>visitCallExpr</span><span class=o>(</span><span class=n>Expr</span><span class=o>.</span><span class=na>Call</span> <span class=n>expr</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>callee</span> <span class=o>=</span> <span class=n>evaluate</span><span class=o>(</span><span class=n>expr</span><span class=o>.</span><span class=na>callee</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>arguments</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Expr</span> <span class=n>argument</span> <span class=o>:</span> <span class=n>expr</span><span class=o>.</span><span class=na>arguments</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>      <span class=n>arguments</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>evaluate</span><span class=o>(</span><span class=n>argument</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>LoxCallable</span> <span class=n>function</span> <span class=o>=</span> <span class=o>(</span><span class=n>LoxCallable</span><span class=o>)</span><span class=n>callee</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>function</span><span class=o>.</span><span class=na>call</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>arguments</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#currying><h2 id=currying><span class=hanchor arialabel=Anchor># </span>Currying</h2></a><p>Named after Haskell Curry, the rule uses <code>*</code> to allow matching a series of calls like <code>fn(1)(2)(3)</code>. In this style, defining a function that takes multiple arguments is as a series of nested functions. Each function takes one argument and returns a new function. That function consumes the next argument, returns yet another function, and so on.</p><a href=#arity><h2 id=arity><span class=hanchor arialabel=Anchor># </span>Arity</h2></a><p>Arity is the fancy term for the number of arguments a function or operation expects. Unary operators have arity one, binary operators two, etc. With functions, the arity is determined by the number of parameters it declares.</p><a href=#native-functions><h2 id=native-functions><span class=hanchor arialabel=Anchor># </span>Native Functions</h2></a><p><strong>Primitives</strong>, <strong>external functions</strong>, or <strong>foreign functions</strong>. They are functions that the interpreter exposes to user code but that are implemented in the host language (in our case Java), not the language being implemented (Lox).</p><p>They provide access to the fundamental services that all programs are defined in terms of. If you don’t provide native functions to access the file system, a user’s going to have a hell of a time writing a program that reads and displays a file.</p><p>Add a new globals environment which will store all the native methods in fixed reference to the global scope:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Interpreter</span> <span class=kd>implements</span> <span class=n>Expr</span><span class=o>.</span><span class=na>Visitor</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;,</span>
</span></span><span class=line><span class=cl>                             <span class=n>Stmt</span><span class=o>.</span><span class=na>Visitor</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>Environment</span> <span class=n>globals</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Environment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>Environment</span> <span class=n>environment</span> <span class=o>=</span> <span class=n>globals</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Interpreter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>globals</span><span class=o>.</span><span class=na>define</span><span class=o>(</span><span class=s>&#34;clock&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>LoxCallable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>      <span class=kd>public</span> <span class=kt>int</span> <span class=nf>arity</span><span class=o>()</span> <span class=o>{</span> <span class=k>return</span> <span class=n>0</span><span class=o>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>      <span class=kd>public</span> <span class=n>Object</span> <span class=nf>call</span><span class=o>(</span><span class=n>Interpreter</span> <span class=n>interpreter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>arguments</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=kt>double</span><span class=o>)</span><span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>()</span> <span class=o>/</span> <span class=n>1000</span><span class=o>.</span><span class=na>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>      <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span> <span class=k>return</span> <span class=s>&#34;&lt;native fn&gt;&#34;</span><span class=o>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#function-declaration><h2 id=function-declaration><span class=hanchor arialabel=Anchor># </span>Function declaration</h2></a><p>Updated grammar:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>declaration    → funDecl
</span></span><span class=line><span class=cl>               | varDecl
</span></span><span class=line><span class=cl>               | statement ;
</span></span><span class=line><span class=cl>			   
</span></span><span class=line><span class=cl>funDecl        → &#34;fun&#34; function ;
</span></span><span class=line><span class=cl>function       → IDENTIFIER &#34;(&#34; parameters? &#34;)&#34; block ;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>parameters     → IDENTIFIER ( &#34;,&#34; IDENTIFIER )* ;
</span></span></code></pre></td></tr></table></div></div><a href=#function-objects><h2 id=function-objects><span class=hanchor arialabel=Anchor># </span>Function Objects</h2></a><p>The implementation of the call method is as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Object</span> <span class=nf>call</span><span class=o>(</span><span class=n>Interpreter</span> <span class=n>interpreter</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                     <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>arguments</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Environment</span> <span class=n>environment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Environment</span><span class=o>(</span><span class=n>interpreter</span><span class=o>.</span><span class=na>globals</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>declaration</span><span class=o>.</span><span class=na>params</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>environment</span><span class=o>.</span><span class=na>define</span><span class=o>(</span><span class=n>declaration</span><span class=o>.</span><span class=na>params</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>).</span><span class=na>lexeme</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=n>arguments</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>interpreter</span><span class=o>.</span><span class=na>executeBlock</span><span class=o>(</span><span class=n>declaration</span><span class=o>.</span><span class=na>body</span><span class=o>,</span> <span class=n>environment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>Functions should encapsulate its parameters, meaning no code outside the function should be able to see them. Create a new environment with access to global environment.</li><li>Bind the params to the values based in as arguments</li><li>Execute the body of the function in a block</li></ol><a href=#call-frames><h3 id=call-frames><span class=hanchor arialabel=Anchor># </span>Call frames</h3></a><p>The compiler allocates stack slots for local variables. How should that work when the set of local variables in a program is distributed across multiple functions?</p><p>We solved this above, by dynamically allocating memory for an environment each time a function was called or a block entered. In clox, we don’t want that kind of performance cost on every function call.</p><a href=#naive-static-option><h4 id=naive-static-option><span class=hanchor arialabel=Anchor># </span>Naive Static Option</h4></a><p>One option would be to keep them totally separate. Each function would get its own dedicated set of slots in the VM stack that it would own forever, even when the function isn’t being called. Each local variable in the entire program would have a bit of memory in the VM that it keeps to itself.</p><a href=#frame-pointers><h4 id=frame-pointers><span class=hanchor arialabel=Anchor># </span>Frame Pointers</h4></a><p>When a function is called, we don’t know where the top of the stack will be because it can be called from different contexts. But, wherever that top happens to be, we do know where all of the function’s local variables will be relative to that starting point.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>fun</span> <span class=nf>first</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>a</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>second</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>b</span> <span class=o>=</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>second</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fun</span> <span class=nf>second</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>c</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>d</span> <span class=o>=</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>first</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>At the beginning of each function call, the VM records the location of the first slot where that function’s own locals begin. The instructions for working with local variables access them by a slot index relative to that, instead of relative to the bottom of the stack like they do today. At compile time, we calculate those relative slots. At runtime, we convert that relative slot to an absolute stack index by adding the function call’s starting slot.
<img src=https://i.imgur.com/RX7qaQg.png width=auto alt></p><a href=#return-addresses><h4 id=return-addresses><span class=hanchor arialabel=Anchor># </span>Return Addresses</h4></a><p>For each live function invocation—each call that hasn’t returned yet—we need to track where on the stack that function’s locals begin, and where the caller should resume. Again, thanks to recursion, there may be multiple return addresses for a single function, so this is a property of each invocation and not the function itself.</p><a href=#return-statements><h2 id=return-statements><span class=hanchor arialabel=Anchor># </span>Return Statements</h2></a><p>In Lox, the body of a function is a list of statements which don’t produce values, so we need dedicated syntax for emitting a result.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>statement      → exprStmt
</span></span><span class=line><span class=cl>               | forStmt
</span></span><span class=line><span class=cl>               | ifStmt
</span></span><span class=line><span class=cl>               | printStmt
</span></span><span class=line><span class=cl>               | returnStmt
</span></span><span class=line><span class=cl>               | whileStmt
</span></span><span class=line><span class=cl>               | block ;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>returnStmt     → &#34;return&#34; expression? &#34;;&#34; ;
</span></span></code></pre></td></tr></table></div></div><a href=#closures><h2 id=closures><span class=hanchor arialabel=Anchor># </span>Closures</h2></a><p>Because the interpreter does not keep the environment surrounding a function around, a closure is essentially a data structure which helps to hold onto surrounding variables where the function is declared.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>fun</span> <span class=nf>makeCounter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fun</span> <span class=nf>count</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>count</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>var</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>makeCounter</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>counter</span><span class=o>();</span> <span class=c1>// &#34;1&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>counter</span><span class=o>();</span> <span class=c1>// &#34;2&#34;.
</span></span></span></code></pre></td></tr></table></div></div><p>Here we pass in the current state of the interpreter environment in function declaration semantics:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LoxFunction</span><span class=o>(</span><span class=n>Stmt</span><span class=o>.</span><span class=na>Function</span> <span class=n>declaration</span><span class=o>,</span> <span class=n>Environment</span> <span class=n>closure</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>closure</span> <span class=o>=</span> <span class=n>closure</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>declaration</span> <span class=o>=</span> <span class=n>declaration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Void</span> <span class=nf>visitFunctionStmt</span><span class=o>(</span><span class=n>Stmt</span><span class=o>.</span><span class=na>Function</span> <span class=n>stmt</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>LoxFunction</span> <span class=n>function</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoxFunction</span><span class=o>(</span><span class=n>stmt</span><span class=o>,</span> <span class=n>environment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>environment</span><span class=o>.</span><span class=na>define</span><span class=o>(</span><span class=n>stmt</span><span class=o>.</span><span class=na>name</span><span class=o>.</span><span class=na>lexeme</span><span class=o>,</span> <span class=n>function</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>Environment</span> <span class=n>environment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Environment</span><span class=o>(</span><span class=n>closure</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>declaration</span><span class=o>.</span><span class=na>params</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span></code></pre></td></tr></table></div></div><a href=#static-scoping><h3 id=static-scoping><span class=hanchor arialabel=Anchor># </span>Static Scoping</h3></a><p>A variable usage refers to the preceding declaration with the same name in the innermost scope that encloses the expression where the variable is used. It is static scoping because running the program should not affect this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>var</span> <span class=n>a</span> <span class=o>=</span> <span class=s>&#34;global&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fun</span> <span class=nf>showA</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span> <span class=n>a</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>showA</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=n>var</span> <span class=n>a</span> <span class=o>=</span> <span class=s>&#34;block&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>showA</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>&ldquo;global&rdquo; should be printed twice, as <code>a</code> refers to the outermost <code>a</code> which is the preceding declaration in the innermost scope. Code may not always execute in the textual order with the introduction of functions which can defer it.</p><p><strong>A block is not all the same scope</strong>
It’s like each <code>var</code> statement splits the block into two separate scopes, the scope before the variable is declared and the one after, which includes the new variable.</p><a href=#persistent-environments><h4 id=persistent-environments><span class=hanchor arialabel=Anchor># </span>Persistent Environments</h4></a><p><strong>Persistent data structures</strong>: unlike the squishy data structures you’re familiar with in imperative programming, a persistent data structure can never be directly modified. Instead, any “modification” to an existing structure produces a brand new object that contains all of the original data and the new modification. The original is left unchanged.
<img src=https://i.imgur.com/lCJlB9t.png width=auto alt></p><a href=#semantic-analysis-for-variable-bindings><h3 id=semantic-analysis-for-variable-bindings><span class=hanchor arialabel=Anchor># </span>Semantic Analysis for variable bindings</h3></a><p>Where a parser tells only if a program is grammatically correct (a <em>syntactic</em> analysis), semantic analysis goes farther and starts to figure out what pieces of the program actually mean. In this case, our analysis will resolve variable bindings. We’ll know not just that an expression <em>is</em> a variable, but <em>which</em> variable it is.</p><a href=#variable-resolution-pass><h4 id=variable-resolution-pass><span class=hanchor arialabel=Anchor># </span>Variable resolution pass</h4></a><p>After the parser produces the syntax tree, but before the interpreter starts executing it, we’ll do a single walk over the tree to resolve all of the variables it contains.</p><p>It walks the tree, visiting each node, but a static analysis is different from a dynamic execution:</p><ul><li><strong>There are no side effects.</strong> When the static analysis visits a print statement, it doesn’t actually print anything. Calls to native functions or other operations that reach out to the outside world are stubbed out and have no effect.</li><li><strong>There is no control flow.</strong> Loops are visited only once. Both branches are visited in <code>if</code> statements. Logic operators are not short-circuited.</li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/Notes/Crafting-Interpreters/ data-ctx=Functions data-src=/Notes/Crafting-Interpreters class=internal-link>Crafting Interpreters</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.brendanang.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.brendanang.dev/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>