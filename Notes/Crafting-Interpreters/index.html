<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Crafting Interpreters #moc Notes from the book Crafting Interpreters. These consists of code examples in Java, but also the core concepts required to build an interpreter from scratch in any language."><title>Crafting Interpreters</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.brendanang.dev//icon.png><link href=https://www.brendanang.dev/styles.c6adaa3b473914a38283f492dfdbcb76.min.css rel=stylesheet><link href=https://www.brendanang.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.brendanang.dev/js/darkmode.f4d43c22d05773345705b5a308888af6.min.js></script>
<script src=https://www.brendanang.dev/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.brendanang.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://www.brendanang.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.brendanang.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.brendanang.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://www.brendanang.dev/",fetchData=Promise.all([fetch("https://www.brendanang.dev/indices/linkIndex.f42c7fcb66d9399c0737437c54fd65de.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.brendanang.dev/indices/contentIndex.9afbb7278a8288f5bf0368f2332484fe.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://www.brendanang.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://www.brendanang.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/www.brendanang.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.brendanang.dev/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.brendanang.dev/>Brendan Ang</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Crafting Interpreters</h1><p class=meta>Last updated
Apr 24, 2023
<a href=https://github.com/bbawj/site/Notes/Crafting%20Interpreters.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://www.brendanang.dev/tags/moc/>Moc</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#parts-of-a-language>Parts of a Language</a><ol><li><a href=#scanning>Scanning</a></li><li><a href=#parsing>Parsing</a></li><li><a href=#static-analysis>Static Analysis</a></li><li><a href=#intermediate-representation>Intermediate Representation</a></li><li><a href=#optimisation>Optimisation</a></li><li><a href=#code-generation>Code generation</a></li><li><a href=#runtime>Runtime</a></li></ol></li><li><a href=#alternate-paths>Alternate Paths</a><ol><li><a href=#tree-walk-interpreters>Tree-walk interpreters</a></li><li><a href=#bytecode-interpreter>Bytecode interpreter</a></li><li><a href=#transpilers>Transpilers</a></li></ol></li><li><a href=#interpreter-vs-compiler>Interpreter vs Compiler</a></li></ol></nav></details></aside><a href=#crafting-interpreters><h1 id=crafting-interpreters><span class=hanchor arialabel=Anchor># </span>Crafting Interpreters</h1></a><p>#moc
Notes from the book
<a href=http://craftinginterpreters.com/welcome.html rel=noopener>Crafting Interpreters</a>. These consists of code examples in Java, but also the core concepts required to build an interpreter from scratch in any language.</p><ul><li><a href=/Notes/Programming-Language-Design rel=noopener class=internal-link data-src=/Notes/Programming-Language-Design>Programming Language Design</a></li><li><a href=/Notes/Scanning/ rel=noopener class=internal-link data-src=/Notes/Scanning/>Scanning</a></li><li><a href=/Notes/Representing-Code/ rel=noopener class=internal-link data-src=/Notes/Representing-Code/>Representing Code</a></li><li><a href=/Notes/Control-Flow rel=noopener class=internal-link data-src=/Notes/Control-Flow>Control Flow</a></li><li><a href=/Notes/Functions/ rel=noopener class=internal-link data-src=/Notes/Functions/>Functions</a></li><li><a href=/Notes/Classes rel=noopener class=internal-link data-src=/Notes/Classes>Classes</a></li><li><a href=/Notes/Virtual-Machine rel=noopener class=internal-link data-src=/Notes/Virtual-Machine>Virtual Machine</a></li><li><a href=/Notes/Compiling-Expressions rel=noopener class=internal-link data-src=/Notes/Compiling-Expressions>Compiling Expressions</a></li></ul><a href=#parts-of-a-language><h2 id=parts-of-a-language><span class=hanchor arialabel=Anchor># </span>Parts of a Language</h2></a><p>The paths from source code to machine code:
<img src=https://i.imgur.com/BzSEUJj.png width=auto alt></p><a href=#scanning><h3 id=scanning><span class=hanchor arialabel=Anchor># </span>Scanning</h3></a><p>Also known as lexing or lexical analysis. Take a linear stream of characters and chunk them into <em>tokens</em>.
<img src=https://i.imgur.com/HTwN5Ae.png width=auto alt></p><p>More of this in <a href=/Notes/Scanning rel=noopener class=internal-link data-src=/Notes/Scanning>Scanning</a>.</p><a href=#parsing><h3 id=parsing><span class=hanchor arialabel=Anchor># </span>Parsing</h3></a><p>Takes the tokens and forms <em>grammar</em> through construction of an
<a href=/Notes/Representing-Code/ rel=noopener class=internal-link data-src=/Notes/Representing-Code/>Abstract Syntax Tree</a>.</p><a href=#static-analysis><h3 id=static-analysis><span class=hanchor arialabel=Anchor># </span>Static Analysis</h3></a><p>&ldquo;In an expression like a + b, we know we are adding a and b, but we don’t know what those names refer to. Are they local variables? Global? Where are they defined?&rdquo;</p><ul><li>Binding: for each <em>identifier</em>, figure out where it is defined and wire them together. This is affected by scoping.</li><li>Type checking: if the language is statically typed, figure out the types of those identifiers and report type errors where operations are not supported.</li></ul><p>Results from the analysis needs to be stored for later use:</p><ul><li>AST: stored back as attributes on the AST which were not previously initialised during parsing</li><li>Symbol table: a lookup table associating each key (identifier) to what it refers to</li></ul><a href=#intermediate-representation><h3 id=intermediate-representation><span class=hanchor arialabel=Anchor># </span>Intermediate Representation</h3></a><p>Compiling code can be viewed as involving two ends. The &ldquo;front-end&rdquo; is specific to the source code language which the program is written in. The &ldquo;back-end&rdquo; is the target architecture which the program will run. IRs allow different front-ends to produce a shared IR, and allow different back-ends to convert the IR to the target architecture.</p><a href=#optimisation><h3 id=optimisation><span class=hanchor arialabel=Anchor># </span>Optimisation</h3></a><p>Swapping parts of the program for parts which have the same semantics but implemented more efficiently.</p><a href=#code-generation><h3 id=code-generation><span class=hanchor arialabel=Anchor># </span>Code generation</h3></a><p>Converting the IR into machine code. There are two options:</p><ol><li>Real machine code generation: native code which the OS can directly execute . This is fast but involves complex work due to high number of instructions. It also makes the code less portable as it will only work on the specific target architecture.</li><li>Virtual machine code i.e. bytecode generation: produce code for a generalised idealised virtual machine which has synthetic instructions mapping more closely to language semantics than to a specific computer architecture</li></ol><a href=#virtual-machine><h4 id=virtual-machine><span class=hanchor arialabel=Anchor># </span>Virtual Machine</h4></a><p>Not to be confused with the
<a href=/Notes/Virtualization/ rel=noopener class=internal-link data-src=/Notes/Virtualization/>system virtual machine</a>. This abstraction refers to process virtual machines, a program that emulates the hypothetical chip to support the virtual architecture (targeted by the virtual machine code) at runtime.</p><a href=#runtime><h3 id=runtime><span class=hanchor arialabel=Anchor># </span>Runtime</h3></a><p>We usually need some services that our language provides while the program is running. E.g.
Automatic memory management: a garbage collector needs to be implemented to reclaim unused bits.</p><p>In compiled languages like Go, the code implementing the runtime is directly inserted into the resulting executable. If a language is run inside an interpreter like Python, the runtime lives there.</p><a href=#alternate-paths><h2 id=alternate-paths><span class=hanchor arialabel=Anchor># </span>Alternate Paths</h2></a><a href=#tree-walk-interpreters><h3 id=tree-walk-interpreters><span class=hanchor arialabel=Anchor># </span>Tree-walk interpreters</h3></a><p>The interpreter traverses the abstract syntax tree and evaluates each node as it goes. IR, code generation not required.</p><p>Those are real advantages. But, on the other hand, it’s <em>not memory-efficient</em>. Each piece of syntax becomes an AST node. A tiny Lox expression like <code>1 + 2</code> turns into a slew of objects with lots of pointers between them, something like:
<img src=https://i.imgur.com/bLsHLtp.png width=auto alt></p><a href=#bytecode-interpreter><h3 id=bytecode-interpreter><span class=hanchor arialabel=Anchor># </span>Bytecode interpreter</h3></a><p>Structurally, bytecode resembles machine code. It’s a dense, linear sequence of binary instructions. That keeps overhead low and plays nice with the cache. However, it’s a much simpler, higher-level instruction set than any real chip out there. (In many bytecode formats, each instruction is only a single byte long, hence “bytecode”.)</p><p>To execute the bytecode, we need to write an <em>emulator</em>—a simulated chip written in software that interprets the bytecode one instruction at a time. A <em>virtual machine (VM)</em>, if you will. If we write our VM in a language like C that is already supported on all the machines we care about, and we can run our emulator on top of any hardware we like.
<img src=https://i.imgur.com/svohXTO.png width=auto alt></p><a href=#transpilers><h3 id=transpilers><span class=hanchor arialabel=Anchor># </span>Transpilers</h3></a><p>Writing a complete backend for a language is a lot of work. Another method could be to write the front end of the language and in the backend, produce a string of valid source code for some other language that is about as high level and use the backend tools for that language to do the rest of the work e.g. Typescript to JavaScript.</p><a href=#interpreter-vs-compiler><h2 id=interpreter-vs-compiler><span class=hanchor arialabel=Anchor># </span>Interpreter vs Compiler</h2></a><p>Compiling is an implementation technique that involves translating a source language to some other usually lower level form. Generating bytecode, transpiling are all examples of compiling.</p><p>An implementation &ldquo;is an interpreter&rdquo; if it takes source code and executes it immediately. Go is an interpreter: <code>go run</code> compiles Go source code to machine code and runs it. Go is a compiler : <code>go build</code> compiles without running.
<img src=https://i.imgur.com/71QCQUY.png width=auto alt></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.brendanang.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://www.brendanang.dev/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>