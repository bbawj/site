<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Transaction Management Transactions are the basic unit of change in a DBMS. It is essential for data recovery and concurrency control."><title>Transaction Management</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://bbawj.github.io/site//icon.png><link href=https://bbawj.github.io/site/styles.879a44c0d79909457a19389c424941d3.min.css rel=stylesheet><link href=https://bbawj.github.io/site/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://bbawj.github.io/site/js/darkmode.604858f0be6a961da2204cc761cc89c4.min.js></script>
<script src=https://bbawj.github.io/site/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://bbawj.github.io/site/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://bbawj.github.io/site/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://bbawj.github.io/site/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://bbawj.github.io/site/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://bbawj.github.io/site/",fetchData=Promise.all([fetch("https://bbawj.github.io/site/indices/linkIndex.eaa5a5e3f843cf23c190313a8448f6ba.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://bbawj.github.io/site/indices/contentIndex.03f3e5ffd91422360f4e62383d7b5198.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://bbawj.github.io/site",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://bbawj.github.io/site",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/bbawj.github.io\/site\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://bbawj.github.io/site/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://bbawj.github.io/site/>bbawj.io</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Transaction Management</h1><p class=meta>Last updated
Nov 8, 2022
<a href=https://github.com/bbawj/site/Notes/Transaction%20Management.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#sql-transactions>SQL Transactions</a></li><li><a href=#acid-properties>ACID Properties</a><ol><li><a href=#atomicity>Atomicity</a></li><li><a href=#consistency>Consistency</a></li><li><a href=#isolation>Isolation</a></li><li><a href=#durability>Durability</a></li></ol></li><li><a href=#primitive-operations>Primitive Operations</a></li><li><a href=#failures>Failures</a><ol><li><a href=#types-of-failures>Types of Failures</a></li></ol></li><li><a href=#recovery-algorithms>Recovery Algorithms</a><ol><li><a href=#undo-logging>Undo Logging</a></li><li><a href=#redo-logging>Redo Logging</a></li><li><a href=#undoredo-logging>Undo/Redo Logging</a></li></ol></li><li><a href=#practice-problems>Practice Problems</a></li></ol></nav></details></aside><a href=#transaction-management><h1 id=transaction-management><span class=hanchor arialabel=Anchor># </span>Transaction Management</h1></a><p>Transactions are the basic unit of change in a DBMS. It is essential for data recovery and concurrency control.</p><blockquote class=[!idea:]-callout><p>[!Idea:]</p><ol><li>Take a database as an input</li><li>Perform an action</li><li>Generate new version of database</li></ol></blockquote><a href=#sql-transactions><h2 id=sql-transactions><span class=hanchor arialabel=Anchor># </span>SQL Transactions</h2></a><ul><li>A new transaction starts with <code>BEGIN</code></li><li>Transactions are stopped with either a <code>COMMIT</code> or <code>ABORT</code></li><li><code>COMMIT</code>: changes are saved</li><li><code>ABORT</code>: changes are undone
<img src=https://i.imgur.com/rc3m2AF.png width=auto alt></li></ul><a href=#acid-properties><h2 id=acid-properties><span class=hanchor arialabel=Anchor># </span>ACID Properties</h2></a><a href=#atomicity><h3 id=atomicity><span class=hanchor arialabel=Anchor># </span>Atomicity</h3></a><p>A transaction is either performed in its entirety (can be in steps) or not performed at all.</p><a href=#logging><h4 id=logging><span class=hanchor arialabel=Anchor># </span>Logging</h4></a><p>DBMS logs all actions so that it can undo the actions of aborted transactions</p><a href=#shadow-paging><h4 id=shadow-paging><span class=hanchor arialabel=Anchor># </span>Shadow paging</h4></a><p>Make copies of pages, perform changes on these copies. Only when transaction commits, the page is made visible to others.</p><a href=#consistency><h3 id=consistency><span class=hanchor arialabel=Anchor># </span>Consistency</h3></a><a href=#database-consistency><h4 id=database-consistency><span class=hanchor arialabel=Anchor># </span>Database consistency</h4></a><p>A database is in consistent state if it obeys all of the consistency (integrity) constraints defined over it. A database may be inconsistent in between states.</p><a href=#transaction-consistency><h4 id=transaction-consistency><span class=hanchor arialabel=Anchor># </span>Transaction consistency</h4></a><p>Database is in consistent state even if there are a number of concurrent transactions</p><a href=#isolation><h3 id=isolation><span class=hanchor arialabel=Anchor># </span>Isolation</h3></a><p>A transaction should appear as though it is executed in isolation from other transactions. An executing transaction cannot reveal its results to other concurrent transactions before its commitment.</p><a href=#concurrency-control-protocol><h4 id=concurrency-control-protocol><span class=hanchor arialabel=Anchor># </span>Concurrency control protocol</h4></a><ul><li>Pessimistic: Do not let problems arise in the first place (prevention)</li><li>Optimistic: Assume conflicts are rare and deal with them when they happen (detection and recovery)</li></ul><a href=#durability><h3 id=durability><span class=hanchor arialabel=Anchor># </span>Durability</h3></a><p>Changes applied to the database by a committed transaction must persist in the database.</p><a href=#primitive-operations><h2 id=primitive-operations><span class=hanchor arialabel=Anchor># </span>Primitive Operations</h2></a><p><img src=https://i.imgur.com/O5iaevr.png width=auto alt></p><a href=#failures><h2 id=failures><span class=hanchor arialabel=Anchor># </span>Failures</h2></a><a href=#types-of-failures><h3 id=types-of-failures><span class=hanchor arialabel=Anchor># </span>Types of Failures</h3></a><a href=#transaction-failures><h4 id=transaction-failures><span class=hanchor arialabel=Anchor># </span>Transaction failures</h4></a><ul><li>Logical Errors: Transaction cannot complete due to some internal error condition (e.g., integrity constraint violation).</li><li>Internal State Errors: DBMS must terminate an active transaction due to an error condition (e.g., deadlock).</li></ul><a href=#system-failures><h4 id=system-failures><span class=hanchor arialabel=Anchor># </span>System failures</h4></a><ul><li>Software Failure: Problem with the DBMS implementation (e.g., uncaught divide-by-zero exception).</li><li>Hardware Failure: The computer hosting the DBMS crashes (e.g., power plug gets pulled, disk crash). They can be recoverable or non-recoverable</li></ul><a href=#recovery-algorithms><h2 id=recovery-algorithms><span class=hanchor arialabel=Anchor># </span>Recovery Algorithms</h2></a><p>Recovery must kick in to ensure the database satisfies the ACID properties in the case of failure. They must carry in 2 parts:</p><ol><li>Actions during normal transaction processing to ensure that the DBMS can recover from a failure.</li><li>Actions after a failure to recover to a state that ensures atomicity, consistency and durability</li></ol><blockquote><p>Ensuring atomicity and durability &ndash; Logging:
The database stores additional files called <em>log files</em>. Logs record every action of each transaction and are append only.</p></blockquote><a href=#undo-logging><h3 id=undo-logging><span class=hanchor arialabel=Anchor># </span>Undo Logging</h3></a><p>Idea: undo the effects of transactions that may not have completed before failure.
<img src=https://i.imgur.com/805J1ia.png width=auto alt>
<img src=https://i.imgur.com/TECxSmC.png width=auto alt></p><blockquote class=rules-callout><p>With undo logging, there are a set of rules the DBMS must follow. Order of writing to disk:</p><ol><li>Log records indicating changed database elements</li><li>Changed database elements themselves</li><li>COMMIT log record</li></ol></blockquote><a href=#recovery-without-checkpoints><h4 id=recovery-without-checkpoints><span class=hanchor arialabel=Anchor># </span>Recovery without checkpoints</h4></a><p><img src=https://i.imgur.com/9i2OUpZ.png width=auto alt>
All undo commands are idempotent, if failure occurs during recovery, we can simply restart.</p><a href=#checkpointing><h4 id=checkpointing><span class=hanchor arialabel=Anchor># </span>Checkpointing</h4></a><p>Use periodic checkpoints to prevent having to read the entirety of the log file for recovery. Any transactions executed before the checkpoint will have finished and there will be no need to undo them.
<img src=https://i.imgur.com/Z54jfvB.png width=auto alt>
Problem</p><ul><li>The database is frozen while performing checkpointing. Active transactions may take a long time to commit or abort and will result in variant performance of the DBMS.</li></ul><a href=#non-quiescent-checkpointing><h4 id=non-quiescent-checkpointing><span class=hanchor arialabel=Anchor># </span>Non-quiescent Checkpointing</h4></a><p>Start checkpointing at any time using the current incomplete transactions.
<img src=https://i.imgur.com/3uaHcFg.png width=auto alt></p><a href=#recovery-with-checkpoints><h4 id=recovery-with-checkpoints><span class=hanchor arialabel=Anchor># </span>Recovery with checkpoints</h4></a><ol><li>Scan backwards identifying transactions which did not commit.</li><li>If we reach END CKPT, we know that the only transactions which may not have committed must be those after the <code>START CKPT</code>. Thus, we can stop at <code>START CKPT</code></li><li>If we reach <code>START CKPT</code> first, we failed during checkpointing and need to search up till the earliest <code>START T</code> of those in the checkpoint, because we know those are the transactions active at the start of the checkpoint</li><li>Undo uncommitted transactions and ignore those that have committed.</li></ol><a href=#limitations><h4 id=limitations><span class=hanchor arialabel=Anchor># </span>Limitations</h4></a><p>Cannot commit a transaction without first writing all its changed data to disk. This means we will need many disk I/O for each transaction.</p><a href=#redo-logging><h3 id=redo-logging><span class=hanchor arialabel=Anchor># </span>Redo Logging</h3></a><p>Do not write all changed data to disk before committing. Write to the main memory log file all the changes to the DB, and commit before any changes are written to disk. Perform recovery by redoing effects of committed transactions before the crash.
<img src=https://i.imgur.com/Zhule0H.png width=auto alt></p><blockquote class=rules-callout><p>If a transaction modifies X, then both &lt;T,x,v> and COMMIT T must be written to disk before OUTPUT(X). Order of writing to disk:</p><ol><li>Log records indicating the changed elements</li><li>COMMIT T log record</li><li>Changes to the elements themselves</li></ol></blockquote><a href=#recovery-without-checkpoints-1><h4 id=recovery-without-checkpoints-1><span class=hanchor arialabel=Anchor># </span>Recovery without checkpoints</h4></a><p><img src=https://i.imgur.com/WuYLOdQ.png width=auto alt>
<img src=https://i.imgur.com/RMa262e.png width=auto alt></p><a href=#checkpointing-1><h4 id=checkpointing-1><span class=hanchor arialabel=Anchor># </span>Checkpointing</h4></a><p>Start checkpointing for all active transactions. When we see an <code>START CHECKPOINT</code>, we can be sure that all prior transactions have been recorded to the disk and there is no need to redo them.
<em>Example where we do not need to redo the actions for T1:</em>
<img src=https://i.imgur.com/MCReHYm.png width=auto alt></p><a href=#recovery-with-checkpoints-1><h4 id=recovery-with-checkpoints-1><span class=hanchor arialabel=Anchor># </span>Recovery with checkpoints</h4></a><ol><li>If we see a <code>END CHKPT</code> in the log, we can be sure that changes made by transactions that have committed before the <code>START CHKPT</code> is already in disk, and we can ignore them. If no <code>END CKPT</code> in logs, we need to search back to next to last <code>START CKPT</code>.</li><li>From <code>START CKPT (T1, ... Tk)</code> we <em>cannot</em> be sure that any transaction that is among the $T_i$ or those started after this checkpoint log have been written to disk. <strong>We must search back until the earliest $T_i$ and redo.</strong></li><li>However, if $T_i$ &rsquo;s commit message is not found, we write <code>ABORT Ti</code> as it must not be redone.</li></ol><a href=#limitations-1><h4 id=limitations-1><span class=hanchor arialabel=Anchor># </span>Limitations</h4></a><p>It requires all modified blocks to be kept in buffers until the transaction commits and the log records have been flushed. This increases the average number of buffers needed by transactions.</p><a href=#undoredo-logging><h3 id=undoredo-logging><span class=hanchor arialabel=Anchor># </span>Undo/Redo Logging</h3></a><p>Increase flexibility by maintaining more information on the log. &lt;T,X,v,w> now stores both old and new values in the log.</p><blockquote class=rule-callout><p>Before modifying any DB element X, the log record must be written to the disk.</p></blockquote><p><img src=https://i.imgur.com/3BiSNNV.png width=auto alt>
We can commit at any time after the &lt;T,B,8,6> record has been written to the disk.
Recovery process:</p><ol><li>Redo all committed transactions top-down</li><li>Undo all uncommitted transactions bottom-up
This is because we may have committed transactions with some of the changes not on disk as well as uncommitted transactions with some of the changes on disk.</li></ol><a href=#checkpointing-2><h4 id=checkpointing-2><span class=hanchor arialabel=Anchor># </span>Checkpointing</h4></a><p><img src=https://i.imgur.com/WBdr1xt.png width=auto alt></p><ul><li>The <code>END CKPT</code> can appear anywhere after the <code>START CKPT</code></li></ul><a href=#recovery-with-checkpoints-2><h4 id=recovery-with-checkpoints-2><span class=hanchor arialabel=Anchor># </span>Recovery with checkpoints</h4></a><p>We are sure we do not need to check any further than the <code>START TRANSACTION</code> of active transactions in the checkpoint as the corresponding <code>END CHECKPOINT</code> ensures that all changes prior to the <code>START</code> have been flushed to the disk.</p><ol><li>If crash occurs at the end, T2 and T3 are identified as committed and we redo actions starting from <code>START CKPT</code></li><li>If crash occurs before <code>COMMIT T3</code>, T2 is committed but. T3 is not. Redo T2 from <code>START CKPT</code> and undo T3 until <code>START T3</code>.</li><li>If crash occurs before <code>END CKPT</code>, any changes made by previous transactions may not have been written to disk. We need to search back to the next to last <code>START CKPT</code>, redo committed transactions and undo incomplete ones up till their corresponding <code>START T</code> logs.</li></ol><a href=#practice-problems><h2 id=practice-problems><span class=hanchor arialabel=Anchor># </span>Practice Problems</h2></a><p><img src=https://i.imgur.com/J2UHbco.png width=auto alt>
a. We know that at an <code>END CHKPNT</code>, all dirty buffers from the corresponding <code>START CKPT</code> are written to disk
A: 21
B: 40, 41
C: 30,31,32,33
D: 50,51,52
b. All uncommitted transactions. T1, T6
c. All committed transactions. T3, T4, T5
d.
A: 21
B: 41. T4 redone
C: 31. T1 undone, T3 redone
D: 52. T5 redone.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/site/4031-Database-Systems/ data-ctx="Transaction Management" data-src=/4031-Database-Systems class=internal-link>4031 Database Systems</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://bbawj.github.io/site/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Brendan Ang using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://bbawj.github.io/site/>Home</a></li><li><a href=https://github.com/bbawj>Github</a></li></ul></footer></div></div></body></html>